name: Update Board Game Database

on:
  schedule:
    # Run daily at 4 AM UTC (after CSV download completes)
    - cron: '0 4 * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  update-database:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Install Chrome
      run: |
        wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
    
    - name: Install Python dependencies
      run: |
        pip install requests selenium pandas
    
    # Step 1: Download CSV
    - name: Download BGG CSV
      env:
        BGG_USERNAME: ${{ secrets.BGG_USERNAME }}
        BGG_PASSWORD: ${{ secrets.BGG_PASSWORD }}
      run: |
        python download_bgg_data.py
    
    # Step 2: Unzip CSV
    - name: Unzip CSV file
      run: |
        unzip -o boardgames_ranks.zip
        ls -lh boardgames_ranks.csv
    
    # Step 3: Download database from latest release
    - name: Download database from releases
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Get the latest release
        LATEST_RELEASE=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
          "https://api.github.com/repos/${{ github.repository }}/releases/latest")
        
        # Extract download URL for boardgames.db
        DB_URL=$(echo "$LATEST_RELEASE" | jq -r '.assets[] | select(.name=="boardgames.db") | .browser_download_url')
        
        if [ -z "$DB_URL" ] || [ "$DB_URL" == "null" ]; then
          echo "Error: Database not found in releases"
          exit 1
        fi
        
        echo "Downloading database from: $DB_URL"
        curl -L -o boardgames.db "$DB_URL"
        ls -lh boardgames.db
    
    # Step 4: Update database
    - name: Update database with new data
      env:
        BGG_TOKEN: ${{ secrets.BGG_TOKEN }}
      run: |
        python enrich_bgg_db_v3.py
    
    # Step 5: Get current date for release tag
    - name: Get current date
      id: date
      run: |
        echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
        echo "datetime=$(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
    
    # Step 6: Create new release with updated database
    - name: Create release and upload database
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Create a new release
        gh release create "db-${{ steps.date.outputs.date }}" \
          --title "Database Update ${{ steps.date.outputs.date }}" \
          --notes "Automated database update - ${{ steps.date.outputs.datetime }}" \
          boardgames.db
        
        # Also update the 'latest' tag to point to this release
        gh release delete latest --yes || true
        gh release create latest \
          --title "Latest Database" \
          --notes "Latest automated database update - ${{ steps.date.outputs.datetime }}" \
          boardgames.db
    
    # Step 7: Upload artifacts for debugging
    - name: Upload artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: update-artifacts-${{ steps.date.outputs.date }}
        path: |
          boardgames_ranks.csv
          boardgames.db
        retention-days: 7
