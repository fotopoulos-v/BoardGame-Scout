name: Update Board Game Database

permissions:
  contents: write

on:
  schedule:
    # Run daily at 4 AM UTC (after CSV download completes)
    - cron: '0 4 * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  update-database:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Chrome
        run: |
          wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable

      - name: Install Python dependencies
        run: |
          pip install requests selenium pandas

      # Step 1: Download CSV
      - name: Download BGG CSV
        env:
          BGG_USERNAME: ${{ secrets.BGG_USERNAME }}
          BGG_PASSWORD: ${{ secrets.BGG_PASSWORD }}
        run: |
          python bg_ranks_csv_download.py

      # Step 2: Unzip CSV
      - name: Unzip CSV file
        run: |
          unzip -o boardgames_ranks.zip
          ls -lh boardgames_ranks.csv

      # Step 3: Download database from release
      - name: Download database from release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RELEASE_TAG="boardgame-database"  # fixed tag
          echo "Downloading boardgames_db.zip from release with tag $RELEASE_TAG..."

          gh release download "$RELEASE_TAG" \
            --pattern boardgames_db.zip \
            --clobber

          unzip -o boardgames_db.zip

          if [ ! -f boardgames.db ]; then
            echo "Error: boardgames.db not found after unzip"
            exit 1
          fi

          ls -lh boardgames.db

      # Step 4: Update database
      - name: Update database with new data
        env:
          BGG_TOKEN: ${{ secrets.BGG_TOKEN }}
        run: |
          python enrich_bgg_db_v3.py

      # Step 5: Get current date for release notes
      - name: Get current date
        id: date
        run: |
          echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          echo "datetime=$(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT

      # Step 6: Update the release with new database
      - name: Update release with new database
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RELEASE_TAG="boardgame-database"  # same fixed tag

          # Zip the updated database
          zip boardgames_db.zip boardgames.db

          # Upload updated database to the existing release (overwrite)
          echo "Uploading updated database..."
          gh release upload "$RELEASE_TAG" boardgames_db.zip --clobber

          # Update release notes with timestamp
          gh release edit "$RELEASE_TAG" \
            --notes "Latest automated database update - ${{ steps.date.outputs.datetime }}"

          echo "âœ… Database updated in release '$RELEASE_TAG'"

      # Step 7: Upload artifacts for debugging
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: update-artifacts-${{ steps.date.outputs.date }}
          path: |
            boardgames_ranks.csv
            boardgames.db
          retention-days: 7

